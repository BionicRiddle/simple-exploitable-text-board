<?php 

header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
header("Cache-Control: post-check=0, pre-check=0", false);
header("Pragma: no-cache");

require 'config.php';
require 'helpers.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // CHECK CRED
    $username = htmlspecialchars($_POST["uname"]);
    $password = htmlspecialchars($_POST["pwd"]);
    
    $valid = true;
    
    $conn = "mysql:host=". DB_HOST . ";dbname=". DB_NAME .";charset=" . DB_CHARSET;
    
    $pdo = new PDO($conn, DB_USER, DB_PASSWORD);
    
    $userstmt = $pdo->prepare("SELECT * FROM `" . TABLE_NAME_USERS . "` WHERE `username` = :username");
    $stmt = $pdo->prepare("SELECT * FROM `" . TABLE_NAME_USERS . "` WHERE `username` = :username");
    
    $userstmt->bindParam(":username", $username, PDO::PARAM_STR);
    $userstmt->execute();
    if ($userstmt->rowCount() == 1) {
        
        $stmt->bindParam(":username", $username, PDO::PARAM_STR);
        $stmt->execute();
        
        $user = $stmt->fetch();
        if(!empty($user['password'])) {
            if (password_verify($password, $user['password'])) {
                // MATCH
                // LOGIN
                //build the headers
                $headers = ['alg'=>'HS256','typ'=>'JWT'];
                
                $iat = date_timestamp_get(date_create());
                
                $exptime = date_create();
                $exptime->modify('+1 months');
                $exp = date_timestamp_get($exptime);
                
                //build the payload
                $payload = ['sub'=>$user['id'],'iat'=>$iat,'exp'=>$exp,'name'=>$user['username']];
                
                $jwt = generate_jwt($headers, $payload);
                
                http_response_code(302);
                echo(HOST . "redirect.php?token=" .$jwt);
                // SUCCESS
                exit();
            }
            
        }
        
    }
    
    // NO LOGIN
    http_response_code(401);
    echo("WRONG_CREDENTIALS");
    exit();    
}
?>
<!DOCTYPE HTML>
<html>
    <head>
	    <script src="login.js?version=<?=CACHE?>"></script>
        <link rel="stylesheet" href="css/style.css?version=<?=CACHE?>">
        <title>LOGGA IN</title>
    </head>
    <body>
        <div class="wrapper">
            <a class="logo" href="/">TWOTTER</a>
            <h2 class="login">Logga In</h2>
            <p class="login" id="alert">&nbsp;</p>
            <form>
                <input class="input" type="text" placeholder="username" id="uname" name="uname" required>
                <br>
                <input class="input" type="password" placeholder="LÃ¶senord" id="pwd" name="pwd" required>
                <br>
                <br>
				<a class="button" href="#" onclick="loginbutton('<?=HOST?>')">LOGGA IN</a>
                <script>
                    document.addEventListener("keyup", function (event) {
                        if (event.keyCode === 13) {
                            event.preventDefault();
                            loginbutton('<?=HOST?>');
                        }
                    });
                </script>

            </form>
            <br>
        </div>
    </body>
</html>
