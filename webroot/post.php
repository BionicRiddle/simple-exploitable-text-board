<?php

header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
header("Cache-Control: post-check=0, pre-check=0", false);
header("Pragma: no-cache");

require_once 'helpers.php';
require_once 'config.php';

$d = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=" . DB_CHARSET;
try {
        if($_SERVER['REQUEST_METHOD'] !== 'POST' || !isset($_POST)) {
                http_response_code(405);
                exit();
        }
        if (empty($_POST)) {
                http_response_code(400);
                exit();
        }

        // Auth Begin
        $jwt = "";
        if (isset($_POST['token']) && !empty($_POST['token'])) {
                if (is_jwt_valid($_POST['token'])) {
                        $jwt = $_POST['token'];
                }
        }
        

        if ($jwt == "") {
                http_response_code(401);
                echo("NO_LOGON");
                exit();
        }
        // Auth OK

        $pdo = new PDO($d, DB_USER, DB_PASSWORD);
        if ($pdo) {
        // CHECK ID
                $userid = getTag($jwt, "sub");

                if (!preg_match("/^[0-9]+$/", $userid)) {
                        http_response_code(400);
                        echo("INVALID_USER");
                        exit();
                }


                // CHECK TEXT

                $text = "";
                if (!isset($_POST['text']) || empty($_POST['text'])) {
                        http_response_code(400);
                        echo("INVALID_TEXT");
                        exit();
                }
                
                if (strlen($_POST['text']) > 256) {
                        http_response_code(400);
                        echo("TEXT_TOO_LONG");
                        exit();
                }

                // Check if text contain atleas one visible character
                if (!preg_match("/[a-zA-Z0-9]+/", $_POST['text'])) {
                        http_response_code(400);
                        echo("INVALID_TEXT");
                        exit();
                }

                if (preg_match("/<script>/i", $_POST['text'])) {
                        http_response_code(400);
                        echo("XSS");
                        exit();
                }
                
                
                $text = htmlspecialchars($_POST['text']);
                $text = $_POST['text']; // XSS
                
                // POST

                $stmt = $pdo->prepare("INSERT INTO `" . TABLE_NAME_POSTS . "` (`posted_by`, `text`) VALUES (:postedby, :text)");
                $stmt->bindParam(":postedby", $userid, PDO::PARAM_INT);
                $stmt->bindParam(":text", $text, PDO::PARAM_STR);
                $stmt->execute();
                if ($stmt->rowCount() == 1) {
                        http_response_code(200);
                        echo('<meta http-equiv="Refresh" content="0; url=\'/\'" />');
                        exit();
                } else {
                        http_response_code(500);
                        echo("ERROR");
                        exit();
                }





        }

} catch (PDOException $e) {
        http_response_code(500);
        error($e->getMessage());
        exit();
}



?>