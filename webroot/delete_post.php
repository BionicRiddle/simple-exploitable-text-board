<?php

header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
header("Cache-Control: post-check=0, pre-check=0", false);
header("Pragma: no-cache");

require_once 'helpers.php';
require_once 'config.php';

$d = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=" . DB_CHARSET;
try {
    if($_SERVER['REQUEST_METHOD'] !== 'POST' || !isset($_POST)) {
        http_response_code(405);
        exit();
    }

    if (empty($_POST)) {
        http_response_code(400);
        echo("MISSING_POST_DATA");
        exit();
    }

    // Auth Begin
    $jwt = "";
    if (isset($_POST['token']) && !empty($_POST['token'])) {
        if (is_jwt_valid($_POST['token'])) {
            $jwt = $_POST['token'];
        }
    }

    if (!isset($_POST['post']) || empty($_POST['post'])) {
        http_response_code(400);
        echo("NO_POST");
        exit();
    }
    

    if ($jwt == "") {
        http_response_code(401);
        echo("NO_LOGON");
        exit();
    }
    // Auth OK

    $pdo = new PDO($d, DB_USER, DB_PASSWORD);
    if ($pdo) {
    // CHECK ID
        $userid = getTag($jwt, "sub");

        if (!preg_match("/^[0-9]+$/", $userid)) {
            http_response_code(400);
            echo("INVALID_USER");
            exit();
        }

        // CHECK IF ADMIN

        $stmt = $pdo->prepare("SELECT * FROM `" . TABLE_NAME_USERS . "` WHERE `id` = :id");

        $stmt->bindParam(":id", $userid, PDO::PARAM_INT);
        $stmt->execute();
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        // check if there are rows returbed
        if ($stmt->rowCount() == 0) {
            http_response_code(400);
            echo("USER_NOT_FOUND");
            exit();
        }

        if ($user['admin'] != 1) {
            http_response_code(403);
            echo("NOT_ADMIN");
            exit();
        }

        // CHECK IF POST EXISTS

        if (!preg_match("/^[0-9]+$/", $_POST['post'])) {
            http_response_code(400);
            echo("INVALID_POST");
            exit();
        }
        $post_id = $_POST['post'];

        $stmt = $pdo->prepare("SELECT * FROM `" . TABLE_NAME_POSTS . "` WHERE `id` = :id");
        $stmt->bindParam(":id", $post_id, PDO::PARAM_INT);
        $stmt->execute();
        $post = $stmt->fetch(PDO::FETCH_ASSOC);
        if (!$post) {
            http_response_code(400);
            echo("POST_NOT_FOUND");
            exit();
        }
        
        // DELETE POST

        $stmt = $pdo->prepare("DELETE FROM `" . TABLE_NAME_POSTS . "` WHERE `id` = :id");
        $stmt->bindParam(":id", $post_id, PDO::PARAM_INT);
        $stmt->execute();

        echo('<meta http-equiv="Refresh" content="0; url=\'/\'" />');
        exit();

    }

} catch (PDOException $e) {
    http_response_code(500);
    error($e->getMessage());
    exit();
}



?>