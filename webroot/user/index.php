<?php

require_once '../helpers.php';
require_once '../config.php';
require_once '../login_gate.php';
// LOGIN GATE

$d = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=" . DB_CHARSET;

$pdo = new PDO($d, DB_USER, DB_PASSWORD);

$stmt = $pdo->prepare("SELECT * FROM `" . TABLE_NAME_USERS . "` WHERE `id` = :id");
$id = getTag($jwt, "sub");
$stmt->bindParam(":id", $id, PDO::PARAM_STR);
$stmt->execute();

$name = $stmt->fetch()['name'];

?>
<!DOCTYPE html>
<html>
    <head>
        <title>Twotter - Edit User</title>
        <link rel="stylesheet" href="../css/style.css">
    </head>
    <body>
        <div class="wrapper">
        <a class="logo" href="/">TWOTTER</a>
        <h2><?= $name ?> (@<?= getTag($jwt, "name") ?>)</h2>
        <h4>Change password:</h4>
        <p>min 6char, 1num, 1upper, 1lower</p>

        
        
        <form action="change_password.php" method="post">
            <table>
                <tr>
                    <input type="hidden" name="token" value="<?php echo($jwt); ?>" required>
                    <td><input type="password" name="oldpassword" placeholder="Old password" required></td>
                    <td><input type="password" pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{6,}" name="password" placeholder="New password" required></td>
                    <td><input type="password" pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{6,}" name="password2" placeholder="Repeat new password" required></td>
                    <!-- Exploitable -->
                    <td><input type="submit" value="Change"></td>
                </tr>
            </table>
        </form>

            <!-- set motd -->
        <?php
            if ($isAdmin) {
                echo <<<MMM
                    <h4>Set MOTD:</h4>
                    <form action="set_motd.php" method="post">
                        <table>
                            <tr>
                                <input type="hidden" name="token" value="$jwt" required>
                                <td><textarea rows="8" cols="60" type="text" name="text" placeholder="New MotD" required></textarea></td>
                                <!-- Exploitable -->
                                <td><input type="submit" value="Change"></td>
                            </tr>
                        </table>
                    </form>
                MMM;
            }
        ?>


        </div>
    </body>
</html>
