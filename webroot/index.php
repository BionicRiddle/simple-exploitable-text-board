<?php

header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
header("Cache-Control: post-check=0, pre-check=0", false);
header("Pragma: no-cache");

$firstpage = "YEET";
require_once 'helpers.php';
require_once 'config.php';
require_once 'login_gate.php';
// LOGIN GATE

echo("<!DOCTYPE HTML>");

$cred = "mysql:host=". DB_HOST . ";dbname=". DB_NAME .";charset=" . DB_CHARSET . ";";
$pdo = new PDO($cred, DB_USER, DB_PASSWORD);

$stmt = $pdo->query("SELECT * FROM " . TABLE_NAME_POSTS . " ORDER BY datetime DESC");
$stmt->execute();
$posts = $stmt->fetchAll(PDO::FETCH_ASSOC);

$userstmt = $pdo->prepare("SELECT * FROM " . TABLE_NAME_USERS . " WHERE id = :id");

// Get MOTD
$stmt = $pdo->query("SELECT * FROM " . TABLE_NAME_MOTD . " ORDER BY `service_motd`.`id` DESC LIMIT 1;");
$stmt->execute();
$motd = $stmt->fetch(PDO::FETCH_ASSOC)['text'];

$domain = HOST;
            
if (strpos(HOST, 'https://') !== false) {
    $hostParts = explode('https://', HOST);
} else {
    $hostParts = explode('http://', HOST);
    
}

if (isset($hostParts[1])) {
    $domain = explode("/", $hostParts[1])[0];
}

?>

<html>
    <head>
        <title>Twotter</title>
        <link rel="stylesheet" href="css/style.css">
        <script>
            function logout() {
                document.cookie = "TOKEN=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;secure=1;samesite=strict;domain=<?=$domain?>";
                location.reload();
            }
    </script>
    </head>
    <body>
        <div class="annoyingad">
            <h3>Download our shitty mobile app</h3>
            <p>Just enter your credit card details and your social security number<br>
            Click <a id="annoyinglink" href="goodapp.apk">here</a> to Download</p>
            
        </div>
        <div class="wrapper">
        <a class="logo" href="/">TWOTTER</a>
<?php 

    if ($loggedin) {
        $name = getTag($jwt, "name");
        echo <<<EEE
            <h2>Logged in as: <a href="/user">@$name </a></h2>
            <a class="button" href="#" onclick="logout();">Logout</a>

            <h1>Write someting:</h1>
            <form action="post.php" method="post">
                <table>
                    <tr>
                        <input type="hidden" name="token" value="$jwt" required>
                        <td><textarea placeholder="Max 256 Char" name="text" rows="5" cols="60" required></textarea></td>
                        <!-- Exploitable -->
                        <td><input class="submit" type="submit" value="Post"></td>
                    </tr>
                </table>
            </form>

        EEE;
        
    } else {
        echo <<<NNN
            <br><br><a class="button" href="login.php">Login</a>
            <a class="button" href="register.php">Register</a>
        NNN;
    }
?>

        <h1>MotD</h1>
        <p><?= $motd ?></p>
        <br>

        <h1>Posts</h1>
        <div id="posts">
            <?php
            for ($i = 0; $i < count($posts); $i++) {
                echo ("<div class=\"post\">");
                $userstmt->bindValue(':id', $posts[$i]['posted_by'] , PDO::PARAM_INT);
                $userstmt->execute();
                $data = $userstmt->fetch(PDO::FETCH_ASSOC);
                $user = $data['name'];
                $username = $data['username'];

                $utime = strtotime($posts[$i]['datetime']);

                # varibale $localtime that takes the $utime that is GMT and converts it to current local time acoding to  $tz
                $localtime = date("Y-m-d H:i:s", $utime + $tz->getOffset(new DateTime));
                echo("<h3>" . $user . " @" . $username . "</h3>");
                echo("<h2>" . $posts[$i]['text'] . "</h2>");
                echo("<p>" . $localtime . "</p>");
                if ($isAdmin) {
                    // Delte post
                    $post_no = $posts[$i]['id'];
                    echo <<<DDD
                        <form class="delete_post" action="delete_post.php" method="post">
                        <input type="hidden" name="token" value="$jwt">
                        <input type="hidden" name="post" value="$post_no">
                        <input class="delete" type="submit" value="Delete">
                        </form>
                    DDD;
                }
                echo("</div>");
            }
            ?>
        </div>

        </div>
    </body>
</html>